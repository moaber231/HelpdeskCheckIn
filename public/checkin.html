<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
  <title>Check In</title>
</head>
<body class="dark">
  <header class="app-header" style="margin-bottom:18px;">
    <div style="display:flex;align-items:center;gap:12px">
      <img src="/assets/logog.png" alt="logo" style="height:36px; border-radius:6px; display:block" onerror="this.style.display='none'" />
      <div class="brand">HelpDesk Check-ins</div>
    </div>
  </header>

  <h2 style="text-align:center;margin-top:0">Check In</h2>
  <div id="msg" class="checkin-card" style="display:none">
    <h3 id="msgTitle"></h3>
    <p id="msgBody" class="muted"></p>
  </div>

  <script>
    (async function(){
      // shared QR flow: try to read device token from localStorage
      const params = new URLSearchParams(window.location.search);
      const deviceFromQuery = params.get('device');
      const stored = window.localStorage.getItem('device_token');
      const device = deviceFromQuery || stored;

      async function doCheckin(device_id) {
        try {
          const res = await fetch('/checkin', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ device_id })});
          const j = await res.json();
          document.getElementById('msg').style.display='block';
          if (res.ok) {
            document.getElementById('msgTitle').innerText = `Hello ${j.checkin.name}`;
            document.getElementById('msgBody').innerText = `You have successfully checked in at ${new Date(j.checkin.time).toLocaleString()}`;
            document.getElementById('msgTitle').className = 'success';
          } else {
            document.getElementById('msgTitle').innerText = 'Check-in failed';
            document.getElementById('msgBody').innerText = j.error || 'Please contact admin';
            document.getElementById('msgTitle').className = 'failure';
          }
        } catch (e) {
          document.getElementById('msg').style.display='block';
          document.getElementById('msgTitle').innerText = 'Network error';
        }
      }

      if (device) {
        // auto-checkin with stored token
        await doCheckin(device);
        return;
      }

      // no token stored â€” prompt user to enter their device id (admin should have pre-registered it)
      const card = document.getElementById('msg');
      card.style.display = 'block';
      document.getElementById('msgTitle').innerText = 'Device not registered';
      const inputHtml = document.createElement('div');
      inputHtml.innerHTML = `
        <div style="margin-top:12px">
          <input id="enterDevice" class="input" placeholder="Enter your Device ID" />
          <div style="margin-top:8px"><label><input id="rememberDevice" type="checkbox" /> Remember this device</label></div>
          <div style="margin-top:10px"><button id="tryBtn" class="button">Check in</button></div>
        </div>`;
      card.appendChild(inputHtml);
      document.getElementById('tryBtn').onclick = async () => {
        const v = document.getElementById('enterDevice').value.trim();
        if (!v) return alert('Enter device id');
        if (document.getElementById('rememberDevice').checked) window.localStorage.setItem('device_token', v);
        await doCheckin(v);
      };
    })();
  </script>
</body>
</html>

